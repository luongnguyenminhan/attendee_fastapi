{% extends "admin/base.html" %}

{% block title %}Bots Management{% endblock %}
{% block page_title %}Bots Management{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="bi bi-robot"></i> All Bots
                </h6>
                <div>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-secondary" onclick="refreshBots()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <button class="btn btn-primary">
                            <i class="bi bi-plus"></i> Create Bot
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if bots %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Project</th>
                                <th>Platform</th>
                                <th>Status</th>
                                <th>Meeting URL</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bot in bots %}
                            <tr>
                                <td>
                                    <code>{{ bot.id }}</code>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar bg-primary rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                            <i class="bi bi-robot text-white"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold">{{ bot.name or 'Unnamed Bot' }}</div>
                                            {% if bot.description %}
                                                <small class="text-muted">{{ bot.description[:30] }}...</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if bot.project %}
                                        <span class="badge bg-info">{{ bot.project.name }}</span>
                                        {% if bot.project.organization %}
                                            <br><small class="text-muted">{{ bot.project.organization.name }}</small>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">No project</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if bot.platform %}
                                        {% if bot.platform == 'zoom' %}
                                            <span class="badge bg-primary"><i class="bi bi-camera-video"></i> Zoom</span>
                                        {% elif bot.platform == 'google_meet' %}
                                            <span class="badge bg-success"><i class="bi bi-google"></i> Google Meet</span>
                                        {% elif bot.platform == 'teams' %}
                                            <span class="badge bg-info"><i class="bi bi-microsoft"></i> Teams</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ bot.platform.title() }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">Unknown</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if bot.status %}
                                        {% if bot.status == 'starting' %}
                                            <span class="badge bg-warning badge-status">Starting</span>
                                        {% elif bot.status == 'in_meeting' %}
                                            <span class="badge bg-success badge-status">In Meeting</span>
                                        {% elif bot.status == 'ended' %}
                                            <span class="badge bg-secondary badge-status">Ended</span>
                                        {% elif bot.status == 'error' %}
                                            <span class="badge bg-danger badge-status">Error</span>
                                        {% else %}
                                            <span class="badge bg-light text-dark badge-status">{{ bot.status.title() }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-light text-dark badge-status">Unknown</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if bot.meeting_url %}
                                        <a href="{{ bot.meeting_url }}" target="_blank" class="text-decoration-none" title="{{ bot.meeting_url }}">
                                            <i class="bi bi-link-45deg"></i> 
                                            {% if bot.meeting_url|length > 30 %}
                                                {{ bot.meeting_url[:30] }}...
                                            {% else %}
                                                {{ bot.meeting_url }}
                                            {% endif %}
                                        </a>
                                    {% else %}
                                        <span class="text-muted">No URL</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">{{ bot.created_at.strftime('%Y-%m-%d %H:%M') if bot.created_at else 'N/A' }}</small>
                                </td>
                                <td class="table-actions">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary" title="View Details">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-info" title="View Logs">
                                            <i class="bi bi-file-text"></i>
                                        </button>
                                        {% if bot.status == 'in_meeting' %}
                                        <button type="button" class="btn btn-outline-warning" title="Stop Bot">
                                            <i class="bi bi-stop"></i>
                                        </button>
                                        {% endif %}
                                        <button type="button" class="btn btn-outline-danger" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-robot display-1 text-muted"></i>
                    <h5 class="mt-3 text-muted">No bots found</h5>
                    <p class="text-muted">There are no bots in the system yet.</p>
                    <button class="btn btn-primary">
                        <i class="bi bi-plus"></i> Create First Bot
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Bot Statistics -->
<div class="row">
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Bot Statistics</h6>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-sm-8">Total Bots:</div>
                    <div class="col-sm-4 text-end"><strong>{{ bots|length }}</strong></div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-8">Active:</div>
                    <div class="col-sm-4 text-end">
                        <strong>{{ bots|selectattr("status", "eq", "in_meeting")|list|length }}</strong>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-sm-8">Starting:</div>
                    <div class="col-sm-4 text-end">
                        <strong>{{ bots|selectattr("status", "eq", "starting")|list|length }}</strong>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-8">Ended:</div>
                    <div class="col-sm-4 text-end">
                        <strong>{{ bots|selectattr("status", "eq", "ended")|list|length }}</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Platform Distribution</h6>
            </div>
            <div class="card-body">
                {% if bots %}
                    {% set zoom_count = bots|selectattr("platform", "eq", "zoom")|list|length %}
                    {% set meet_count = bots|selectattr("platform", "eq", "google_meet")|list|length %}
                    {% set teams_count = bots|selectattr("platform", "eq", "teams")|list|length %}
                    
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div><i class="bi bi-camera-video text-primary"></i> Zoom:</div>
                        <span class="badge bg-primary">{{ zoom_count }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div><i class="bi bi-google text-success"></i> Google Meet:</div>
                        <span class="badge bg-success">{{ meet_count }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div><i class="bi bi-microsoft text-info"></i> Teams:</div>
                        <span class="badge bg-info">{{ teams_count }}</span>
                    </div>
                {% else %}
                <div class="text-center text-muted">
                    <p>No bots to analyze</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Recent Activity</h6>
            </div>
            <div class="card-body">
                {% if bots %}
                    {% set recent_bots = bots|sort(attribute='created_at', reverse=true)|list %}
                    {% for bot in recent_bots[:5] %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="text-truncate me-2">
                            <div class="small fw-bold">{{ bot.name or 'Unnamed Bot' }}</div>
                            <small class="text-muted">{{ bot.created_at.strftime('%m/%d %H:%M') if bot.created_at else 'N/A' }}</small>
                        </div>
                        <div>
                            {% if bot.status == 'in_meeting' %}
                                <span class="badge bg-success">Active</span>
                            {% elif bot.status == 'starting' %}
                                <span class="badge bg-warning">Starting</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ bot.status|title if bot.status else 'Unknown' }}</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center text-muted">
                    <p>No recent activity</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="filterBots('all')">
                        <i class="bi bi-robot"></i> All Bots
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="filterBots('active')">
                        <i class="bi bi-play-circle"></i> Active Bots
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="filterBots('starting')">
                        <i class="bi bi-hourglass"></i> Starting
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="filterBots('ended')">
                        <i class="bi bi-stop-circle"></i> Ended
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function filterBots(type) {
    console.log('Filter bots by:', type);
    // This would be implemented with HTMX or JavaScript filtering
    document.querySelectorAll('.card .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

function refreshBots() {
    location.reload();
}
</script>
{% endblock %}